<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>üéÑ Christmas Magic</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Times+New+Roman&display=swap" rel="stylesheet">

    <style>
        :root { --c-gold: #d4af37; --c-cream: #fceea7; }
        body { margin: 0; overflow: hidden; background-color: #000; font-family: 'Times New Roman', serif; -webkit-tap-highlight-color: transparent; }
        
        #loader {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 9999; display: flex; flex-direction: column;
            justify-content: center; align-items: center; transition: opacity 0.8s ease;
        }
        .spinner {
            width: 40px; height: 40px; border: 3px solid rgba(212, 175, 55, 0.3);
            border-top: 3px solid var(--c-gold); border-radius: 50%;
            animation: spin 1s linear infinite; margin-bottom: 20px;
        }
        .loader-text { color: var(--c-gold); font-family: 'Cinzel', serif; font-size: 14px; text-align: center; line-height: 1.5; }
        .start-btn {
            margin-top: 30px; padding: 12px 40px; border: 1px solid var(--c-gold);
            background: rgba(212, 175, 55, 0.1); color: var(--c-gold); font-family: serif;
            font-size: 16px; letter-spacing: 2px; display: none; cursor: pointer;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        #ui-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; transition: opacity 0.5s ease;
            display: flex; flex-direction: column; justify-content: space-between;
            padding-bottom: 30px; box-sizing: border-box;
        }
        .ui-hidden { opacity: 0 !important; pointer-events: none !important; }

        h1 {
            text-align: center; font-family: 'Cinzel', serif; font-size: 32px;
            margin-top: 20px;
            background: linear-gradient(to bottom, #fff, var(--c-gold));
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            text-shadow: 0 0 15px rgba(212, 175, 55, 0.5); pointer-events: auto;
        }

        .controls-area { width: 100%; display: flex; flex-direction: column; align-items: center; pointer-events: auto; }
        .upload-wrapper { position: relative; overflow: hidden; margin-bottom: 15px; }
        .btn {
            background: rgba(0, 0, 0, 0.6); backdrop-filter: blur(8px);
            border: 1px solid var(--c-gold); color: var(--c-gold);
            padding: 10px 24px; font-family: serif; font-size: 12px;
            text-transform: uppercase; letter-spacing: 2px;
        }
        input[type="file"] { position: absolute; top: 0; left: 0; opacity: 0; width: 100%; height: 100%; }
        .toggle-ui {
            margin-top: 10px; color: rgba(255,255,255,0.5); font-size: 10px;
            border: 1px solid rgba(255,255,255,0.2); padding: 5px 10px; border-radius: 15px;
        }
        #vision-container { opacity: 0; pointer-events: none; position: absolute; bottom: 0; right: 0; }
        
        /* ÈîôËØØÊèêÁ§∫ */
        #ai-status {
            position: absolute; bottom: 5px; right: 5px; color: rgba(255,255,255,0.3); font-size: 10px; pointer-events: none;
        }
    </style>
    
    <script type="importmap">
    {
        "imports": {
            "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
            "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/",
            "@mediapipe/tasks-vision": "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.3/+esm"
        }
    }
    </script>
</head>
<body>

    <div id="loader">
        <div class="spinner"></div>
        <div class="loader-text" id="loader-msg">Ê≠£Âú®ÂáÜÂ§áËäÇÊó•È≠îÊ≥ï...</div>
        <button class="start-btn" id="startBtn">ÁÇπ Âáª Ëøõ ÂÖ•</button>
    </div>

    <div id="ui-layer">
        <h1>Merry Christmas</h1>
        <div class="controls-area">
            <div class="upload-wrapper">
                <button class="btn">‰∏ä‰º†ÁÖßÁâá (Add Photo)</button>
                <input type="file" id="imageInput" accept="image/*">
            </div>
            <div class="toggle-ui" id="hideUiBtn">ÈöêËóèÁïåÈù¢</div>
        </div>
    </div>
    <div id="ai-status"></div>

    <div id="vision-container">
        <video id="webcam" autoplay playsinline muted></video>
    </div>

    <script type="module">
        import * as THREE from 'three';
        import { RoomEnvironment } from 'three/addons/environments/RoomEnvironment.js';
        import { EffectComposer } from 'three/addons/postprocessing/EffectComposer.js';
        import { RenderPass } from 'three/addons/postprocessing/RenderPass.js';
        import { UnrealBloomPass } from 'three/addons/postprocessing/UnrealBloomPass.js';
        import { FilesetResolver, HandLandmarker } from '@mediapipe/tasks-vision';

        // --- ÈÖçÁΩÆ ---
        const IS_MOBILE = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        const CONFIG = {
            colors: { gold: 0xd4af37, red: 0xaa0000 },
            particles: { main: IS_MOBILE ? 600 : 1500 }, // ÂáèÂ∞ëÁ≤íÂ≠êÈò≤Âç°È°ø
            camera: { pos: new THREE.Vector3(0, 2, IS_MOBILE ? 70 : 50) }
        };

        const STATE = { mode: 'tree', targetRotation: { x: 0, y: 0 }, focusTarget: null };

        // --- Ê†∏ÂøÉÁ±ª ---
        class AssetFactory {
            static createCandyCaneTexture() {
                const c = document.createElement('canvas'); c.width=64; c.height=64;
                const ctx=c.getContext('2d'); ctx.fillStyle='#fff'; ctx.fillRect(0,0,64,64);
                ctx.fillStyle='#cc0000'; ctx.beginPath();
                for(let i=-64; i<128; i+=16) { ctx.moveTo(i,0); ctx.lineTo(i+8,0); ctx.lineTo(i-56,64); ctx.lineTo(i-64,64); ctx.fill(); }
                return new THREE.CanvasTexture(c);
            }
            static createDefaultPhoto() {
                const c=document.createElement('canvas'); c.width=256; c.height=256;
                const ctx=c.getContext('2d'); ctx.fillStyle='#fceea7'; ctx.fillRect(0,0,256,256);
                ctx.fillStyle='#000'; ctx.font='30px Times New Roman'; ctx.textAlign='center';
                ctx.fillText('JOYEUX',128,110); ctx.fillText('NOEL',128,150);
                const t = new THREE.CanvasTexture(c); t.colorSpace = THREE.SRGBColorSpace; return t;
            }
        }

        class ParticleSystem {
            constructor(scene) {
                this.scene = scene;
                this.group = new THREE.Group();
                this.scene.add(this.group);
                this.particles = [];
                this.mat = {
                    gold: new THREE.MeshStandardMaterial({ color: CONFIG.colors.gold, metalness:0.8, roughness:0.2 }),
                    red: new THREE.MeshPhysicalMaterial({ color: CONFIG.colors.red, metalness:0.2, roughness:0.1 }),
                    cane: new THREE.MeshStandardMaterial({ map: AssetFactory.createCandyCaneTexture() })
                };
                this.geo = { box: new THREE.BoxGeometry(0.5,0.5,0.5), sphere: new THREE.SphereGeometry(0.3,12,12) };
                this.init();
            }

            init() {
                for(let i=0; i<CONFIG.particles.main; i++) {
                    const type = Math.random();
                    let mesh;
                    if(type<0.6) mesh = new THREE.Mesh(this.geo.box, this.mat.gold);
                    else mesh = new THREE.Mesh(this.geo.sphere, this.mat.red);
                    this.addP(mesh, 'DECO');
                }
                this.addPhoto(AssetFactory.createDefaultPhoto());
            }

            addP(mesh, type) {
                mesh.userData = { 
                    tPos: new THREE.Vector3(), tScale: 1, type: type, 
                    treeH: Math.random(), angleOffset: Math.random() * Math.PI * 2
                };
                mesh.position.set((Math.random()-0.5)*50, (Math.random()-0.5)*50, (Math.random()-0.5)*50);
                this.group.add(mesh);
                this.particles.push(mesh);
            }

            addPhoto(tex) {
                const g = new THREE.Group();
                const frame = new THREE.Mesh(new THREE.BoxGeometry(2.2,2.2,0.1), this.mat.gold);
                const photo = new THREE.Mesh(new THREE.PlaneGeometry(2,2), new THREE.MeshBasicMaterial({map:tex}));
                photo.position.z = 0.06;
                g.add(frame); g.add(photo);
                this.addP(g, 'PHOTO');
                this.updateTargets();
            }

            updateTargets() {
                this.particles.forEach((p, i) => {
                    const d = p.userData;
                    if(STATE.mode === 'tree') {
                        const h = -15 + d.treeH * 30;
                        const r = 12 * (1 - d.treeH);
                        const a = d.treeH * 25 + d.angleOffset;
                        d.tPos.set(Math.cos(a)*r, h, Math.sin(a)*r);
                        d.tScale = d.type==='PHOTO'?0.8:1;
                        p.lookAt(0, h, 0);
                    } else if(STATE.mode === 'scatter') {
                        if(p.position.length() < 5 || p.position.length() > 25) {
                            d.tPos.setFromSphericalCoords(10+Math.random()*10, Math.random()*Math.PI, Math.random()*Math.PI*2);
                        }
                        d.tScale = 1;
                    } else if (STATE.mode === 'focus') {
                        if(p === STATE.focusTarget) {
                            d.tPos.set(0, 1, CONFIG.camera.pos.z - 10); // Ëá™ÈÄÇÂ∫îË∑ùÁ¶ª
                            d.tScale = 3.5;
                            p.rotation.set(0,0,0);
                        } else {
                            d.tPos.set((Math.random()-0.5)*80, (Math.random()-0.5)*80, -20);
                            d.tScale = 0.1;
                        }
                    }
                });
            }

            animate() {
                if(STATE.mode === 'focus' && !STATE.focusTarget) {
                    const photos = this.particles.filter(p => p.userData.type === 'PHOTO');
                    if(photos.length) { STATE.focusTarget = photos[Math.floor(Math.random()*photos.length)]; this.updateTargets(); }
                } else if (STATE.mode !== 'focus') STATE.focusTarget = null;

                this.particles.forEach(p => {
                    p.position.lerp(p.userData.tPos, 0.04);
                    const s = THREE.MathUtils.lerp(p.scale.x, p.userData.tScale, 0.05);
                    p.scale.setScalar(s);
                    if(STATE.mode === 'scatter') { p.rotation.x+=0.01; p.rotation.y+=0.01; }
                });
                
                // Ëß¶Êë∏/ÊâãÂäøÊóãËΩ¨
                this.group.rotation.y = THREE.MathUtils.lerp(this.group.rotation.y, STATE.targetRotation.y, 0.05);
                this.group.rotation.x = THREE.MathUtils.lerp(this.group.rotation.x, STATE.targetRotation.x, 0.05);
            }
        }

        // --- ËßÜËßâÊéßÂà∂ (Èò≤ÈòªÂ°ûÁâà) ---
        class Vision {
            constructor() { this.video = document.getElementById('webcam'); }
            
            async init() {
                try {
                    document.getElementById('ai-status').innerText = "AI Âä†ËΩΩ‰∏≠...";
                    // ËÆæÁΩÆË∂ÖÊó∂ÔºåÂ¶ÇÊûú Google Ëøû‰∏ç‰∏äÔºå5ÁßíÂêéËá™Âä®ÊîæÂºÉ
                    const loadPromise = async () => {
                        const vision = await FilesetResolver.forVisionTasks("https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.3/wasm");
                        this.landmarker = await HandLandmarker.createFromOptions(vision, {
                            baseOptions: { 
                                // Â∞ùËØïÂä†ËΩΩÔºåÂ¶ÇÊûúÂ§±Ë¥• catch ‰ºöÊçïËé∑
                                modelAssetPath: `https://storage.googleapis.com/mediapipe-models/hand_landmarker/hand_landmarker/float16/1/hand_landmarker.task`, 
                                delegate: "GPU" 
                            },
                            runningMode: "VIDEO", numHands: 1
                        });
                        return true;
                    };

                    // Ë∂ÖÊó∂ÊéßÂà∂
                    const timeoutPromise = new Promise((_, reject) => setTimeout(() => reject("Timeout"), 6000));
                    await Promise.race([loadPromise(), timeoutPromise]);

                    const stream = await navigator.mediaDevices.getUserMedia({ 
                        video: { facingMode: 'user', width: { ideal: 320 }, height: { ideal: 240 } } 
                    });
                    this.video.srcObject = stream;
                    await new Promise(r => this.video.onloadedmetadata = r);
                    this.video.play();
                    document.getElementById('ai-status').innerText = "AI Â∑≤Â∞±Áª™";
                } catch(e) {
                    console.log("AI Load Failed (Expected in China):", e);
                    document.getElementById('ai-status').innerText = "‰ªÖËß¶Êë∏Ê®°Âºè";
                }
            }

            process() {
                if(!this.landmarker || this.video.paused) return;
                try {
                    if(this.video.currentTime !== this.lastTime) {
                        this.lastTime = this.video.currentTime;
                        const res = this.landmarker.detectForVideo(this.video, performance.now());
                        if(res.landmarks && res.landmarks.length) {
                            const lm = res.landmarks[0];
                            STATE.targetRotation.y = -(lm[9].x - 0.5) * 3; 
                            const pinch = Math.hypot(lm[4].x-lm[8].x, lm[4].y-lm[8].y);
                            if(pinch < 0.06) this.setMode('focus');
                            else if(Math.hypot(lm[8].x-lm[0].x, lm[8].y-lm[0].y) > 0.3) this.setMode('scatter');
                            else this.setMode('tree');
                        }
                    }
                } catch(err) {} // ÂøΩÁï•ËøêË°åÊó∂ÈîôËØØ
            }
            setMode(m) { if(STATE.mode !== m) { STATE.mode = m; window.app.sys.updateTargets(); } }
        }

        // --- ‰∏ªÁ®ãÂ∫è ---
        class App {
            constructor() {
                // ÂàùÂßãÂåñÊåâÈíÆÈÄªËæë
                const btn = document.getElementById('startBtn');
                btn.style.display = 'block';
                btn.onclick = () => this.start();
                
                // Ëß¶Êë∏ÊéßÂà∂ (Êõø‰ª£ÊâãÂäø)
                let touchStartX = 0;
                document.addEventListener('touchstart', e => touchStartX = e.touches[0].clientX);
                document.addEventListener('touchmove', e => {
                    const deltaX = e.touches[0].clientX - touchStartX;
                    STATE.targetRotation.y += deltaX * 0.005;
                    touchStartX = e.touches[0].clientX;
                });
                
                // ÂèåÂáªÂàáÊç¢Ê®°Âºè
                document.addEventListener('dblclick', () => {
                    const modes = ['tree', 'scatter', 'focus'];
                    const next = modes[(modes.indexOf(STATE.mode)+1)%3];
                    STATE.mode = next;
                    this.sys.updateTargets();
                });
            }

            async start() {
                // 1. ÁïåÈù¢ÂèçÈ¶à
                const loader = document.getElementById('loader');
                document.getElementById('startBtn').style.display = 'none';
                document.getElementById('loader-msg').innerText = "Ê≠£Âú®ÁÇπ‰∫ÆÂú£ËØûÊ†ë...";

                // 2. Three.js ÂàùÂßãÂåñ
                this.renderer = new THREE.WebGLRenderer({ antialias: false, powerPreference: "high-performance" });
                this.renderer.setPixelRatio(Math.min(window.devicePixelRatio, 1.5));
                this.renderer.setSize(window.innerWidth, window.innerHeight);
                this.renderer.toneMapping = THREE.ReinhardToneMapping;
                document.body.appendChild(this.renderer.domElement);

                this.scene = new THREE.Scene();
                this.camera = new THREE.PerspectiveCamera(60, window.innerWidth/window.innerHeight, 0.1, 200);
                this.camera.position.copy(CONFIG.camera.pos);

                const pmrem = new THREE.PMREMGenerator(this.renderer);
                this.scene.environment = pmrem.fromScene(new RoomEnvironment(), 0.04).texture;
                this.scene.add(new THREE.AmbientLight(0xffffff, 0.5));
                this.scene.add(new THREE.PointLight(0xffaa00, 2, 25));

                this.composer = new EffectComposer(this.renderer);
                this.composer.addPass(new RenderPass(this.scene, this.camera));
                this.composer.addPass(new UnrealBloomPass(new THREE.Vector2(window.innerWidth, window.innerHeight), 1.2, 0.5, 0.8));

                this.sys = new ParticleSystem(this.scene);
                
                // 3. „ÄêÂÖ≥ÈîÆ‰øÆÊîπ„Äë‰∏çÁ≠âÂæÖ AIÔºåÁõ¥Êé•ÁßªÈô§ Loader ÊòæÁ§∫Âú∫ÊôØ
                setTimeout(() => {
                    loader.style.opacity = 0;
                    setTimeout(() => loader.remove(), 800);
                }, 100);

                window.app = this;
                this.loop();

                // 4. ÂêéÂè∞Â∞ùËØïÂä†ËΩΩ AI
                this.vision = new Vision();
                await this.vision.init(); // Âú®ÂêéÂè∞ËøêË°åÔºå‰∏çÈòªÂ°ûÁîªÈù¢
                
                // UI ‰∫ã‰ª∂
                document.getElementById('imageInput').addEventListener('change', (e) => {
                    const f = e.target.files[0];
                    if(!f) return;
                    const r = new FileReader();
                    r.onload = (ev) => new THREE.TextureLoader().load(ev.target.result, t => {
                        t.colorSpace = THREE.SRGBColorSpace;
                        this.sys.addPhoto(t);
                    });
                    r.readAsDataURL(f);
                });
                
                let uiVisible = true;
                const ui = document.getElementById('ui-layer');
                document.getElementById('hideUiBtn').onclick = (e) => {
                    e.stopPropagation(); uiVisible = !uiVisible; ui.classList.toggle('ui-hidden');
                };
            }

            loop() {
                requestAnimationFrame(() => this.loop());
                if(this.vision) this.vision.process();
                this.sys.animate();
                this.composer.render();
            }
        }

        new App();
    </script>
</body>
</html>
