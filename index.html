<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Merry Christmas</title>
    <style>
        body {
            background-color: #000;
            margin: 0;
            overflow: hidden;
            touch-action: none;
        }
        canvas { display: block; }
        .ui {
            position: absolute; top: 10%; width: 100%; text-align: center;
            pointer-events: none; z-index: 10;
        }
        h1 {
            color: #d4af37; font-family: serif; font-size: 40px; margin: 0;
            text-shadow: 0 0 15px rgba(212,175,55,0.8);
        }
        p { color: rgba(255,255,255,0.5); font-size: 12px; margin-top: 5px; }
    </style>
</head>
<body>
    <div class="ui">
        <h1>Merry Christmas</h1>
        <p>ğŸ„ æ‹–åŠ¨æ—‹è½¬ Â· åŒå‡»æš‚åœ ğŸ„</p>
    </div>
    <canvas id="canvas"></canvas>

    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');

        let width, height;
        const particles = [];
        
        // 3D å‚æ•°
        let angleY = 0;
        let targetAngleY = 0.002;
        let autoRotate = true;
        const FOCAL = 800; // ç„¦è·

        function resize() {
            width = canvas.width = window.innerWidth;
            height = canvas.height = window.innerHeight;
        }
        window.addEventListener('resize', resize);
        resize();

        // --- ç²’å­ç±» ---
        class Particle {
            constructor(type) {
                this.type = type; // 'leaf', 'deco', 'snow', 'trunk', 'star'
                this.reset();
            }

            reset() {
                this.y = Math.random() * 600 - 300; // é«˜åº¦èŒƒå›´ -300 åˆ° 300
                const hPercent = (this.y + 300) / 600; // 0(åº•) åˆ° 1(é¡¶)

                // æ ‘å½¢é€»è¾‘
                if (this.type === 'leaf' || this.type === 'deco') {
                    // åœ†é”¥åŠå¾„ï¼Œç¨å¾®å¸¦ç‚¹å¼§åº¦
                    const maxR = 220 * (1 - hPercent) + 10; 
                    const angle = Math.random() * Math.PI * 2;
                    // è®©ç²’å­åˆ†å¸ƒåœ¨è¡¨é¢å’Œå†…éƒ¨
                    const r = maxR * Math.sqrt(Math.random()); 

                    this.x = Math.cos(angle) * r;
                    this.z = Math.sin(angle) * r;
                    
                    // é¢œè‰²é€»è¾‘
                    if (this.type === 'leaf') {
                        // ç»¿è‰²ç³»ï¼šæ·±ç»¿åˆ°å«©ç»¿
                        const g = Math.floor(100 + Math.random() * 155);
                        this.color = `rgba(0, ${g}, 50, 0.8)`;
                        this.size = 1.5;
                    } else {
                        // è£…é¥°ç‰©ï¼šåªåˆ†å¸ƒåœ¨æ ‘è¡¨é¢
                        this.x = Math.cos(angle) * maxR;
                        this.z = Math.sin(angle) * maxR;
                        const isGold = Math.random() > 0.5;
                        this.color = isGold ? '#ffd700' : '#ff3333';
                        this.size = 3.5;
                    }
                } 
                else if (this.type === 'trunk') {
                    // æ ‘å¹² (åœ†æŸ±ä½“)
                    const angle = Math.random() * Math.PI * 2;
                    const r = Math.random() * 25;
                    this.x = Math.cos(angle) * r;
                    this.z = Math.sin(angle) * r;
                    this.y = 300 + Math.random() * 100; // åœ¨æ ‘åº•ä¹‹ä¸‹
                    this.color = '#5c4033'; // è¤è‰²
                    this.size = 2;
                }
                else if (this.type === 'snow') {
                    // é›ªèŠ±
                    this.x = (Math.random() - 0.5) * width;
                    this.y = (Math.random() - 0.5) * height;
                    this.z = (Math.random() - 0.5) * 600;
                    this.color = 'rgba(255,255,255,0.6)';
                    this.size = Math.random() * 2 + 0.5;
                    this.fallSpeed = 1 + Math.random();
                }

                // 3D åæ ‡
                this.tx = this.x;
                this.ty = this.y;
                this.tz = this.z;
            }

            update() {
                // é›ªèŠ±ä¸‹è½
                if (this.type === 'snow') {
                    this.y += this.fallSpeed;
                    if (this.y > 400) this.y = -400;
                }

                // æ—‹è½¬å…¬å¼
                const cos = Math.cos(angleY);
                const sin = Math.sin(angleY);
                
                // ç»• Y è½´æ—‹è½¬
                const rx = this.x * cos - this.z * sin;
                const rz = this.z * cos + this.x * sin;

                // æŠ•å½± (3D -> 2D)
                const depth = FOCAL + rz;
                const scale = FOCAL / depth;

                this.projX = width / 2 + rx * scale;
                this.projY = height / 2 + (this.y - 50) * scale; // -50 æ•´ä½“ä¸Šç§»
                this.projSize = this.size * scale;
                this.projScale = scale; // å­˜ä¸‹æ¥ç”¨äºæ’åº
                this.isVisible = depth > 0;
            }

            draw() {
                if (!this.isVisible) return;
                
                ctx.beginPath();
                ctx.fillStyle = this.color;
                
                if (this.type === 'deco') {
                    // è£…é¥°ç‰©åŠ ç‚¹å‘å…‰æ™•
                    ctx.shadowBlur = 10;
                    ctx.shadowColor = this.color;
                } else {
                    ctx.shadowBlur = 0;
                }
                
                ctx.arc(this.projX, this.projY, this.projSize, 0, Math.PI * 2);
                ctx.fill();
            }
        }

        // --- äº”è§’æ˜Ÿç±» ---
        class Star {
            constructor() {
                this.y = -310; // æ ‘é¡¶
                this.size = 30;
                this.color = '#ffd700';
            }
            draw() {
                // æ˜Ÿæ˜Ÿä¹Ÿè¦æ—‹è½¬å’ŒæŠ•å½±
                const cos = Math.cos(angleY);
                const sin = Math.sin(angleY);
                // æ˜Ÿæ˜Ÿä¸­å¿ƒåæ ‡ (0, -310, 0)
                const rz = 0 * cos + 0 * sin; // zæ˜¯0
                const depth = FOCAL + rz;
                const scale = FOCAL / depth;
                
                const px = width / 2;
                const py = height / 2 + (this.y - 50) * scale;
                
                if (depth > 0) {
                    ctx.save();
                    ctx.translate(px, py);
                    // æ˜Ÿæ˜Ÿè‡ªè½¬
                    ctx.rotate(-angleY); 
                    ctx.beginPath();
                    ctx.fillStyle = this.color;
                    ctx.shadowBlur = 20;
                    ctx.shadowColor = this.color;
                    
                    // ç”»äº”è§’æ˜Ÿè·¯å¾„
                    for (let i = 0; i < 5; i++) {
                        ctx.lineTo(Math.cos((18 + i * 72) * 0.01745) * this.size * scale,
                                   -Math.sin((18 + i * 72) * 0.01745) * this.size * scale);
                        ctx.lineTo(Math.cos((54 + i * 72) * 0.01745) * this.size * 0.5 * scale,
                                   -Math.sin((54 + i * 72) * 0.01745) * this.size * 0.5 * scale);
                    }
                    ctx.closePath();
                    ctx.fill();
                    ctx.restore();
                }
            }
        }

        // --- åˆå§‹åŒ– ---
        function init() {
            // 1500ç‰‡æ ‘å¶
            for(let i=0; i<1500; i++) particles.push(new Particle('leaf'));
            // 150ä¸ªè£…é¥°çƒ
            for(let i=0; i<150; i++) particles.push(new Particle('deco'));
            // 200ä¸ªæ ‘å¹²ç‚¹
            for(let i=0; i<200; i++) particles.push(new Particle('trunk'));
            // 300ä¸ªé›ªèŠ±
            for(let i=0; i<300; i++) particles.push(new Particle('snow'));
        }
        
        const star = new Star();
        init();

        // --- äº¤äº’ ---
        let startX = 0;
        let isDragging = false;
        document.addEventListener('touchstart', e => { startX = e.touches[0].clientX; isDragging = true; });
        document.addEventListener('touchmove', e => {
            if(isDragging) {
                const dx = e.touches[0].clientX - startX;
                angleY -= dx * 0.005; // æ‹–åŠ¨è·Ÿéš
                startX = e.touches[0].clientX;
                autoRotate = false;
            }
        });
        document.addEventListener('touchend', () => { isDragging = false; autoRotate = true; });
        document.addEventListener('dblclick', () => autoRotate = !autoRotate);

        // --- åŠ¨ç”»å¾ªç¯ ---
        function animate() {
            ctx.fillStyle = '#050505';
            ctx.fillRect(0, 0, width, height);

            if(autoRotate) angleY += 0.005;

            // 1. æ›´æ–°æ‰€æœ‰ç‚¹
            particles.forEach(p => p.update());

            // 2. æ·±åº¦æ’åº (Z-Sort) é˜²æ­¢é®æŒ¡é”™è¯¯
            particles.sort((a, b) => b.projScale - a.projScale);

            // 3. ç»˜åˆ¶
            // å…ˆç”»æ ‘å¹²å’Œå¶å­/è£…é¥°
            particles.forEach(p => {
                // ç®€å•çš„é®æŒ¡é€»è¾‘ï¼šå¦‚æœæ˜Ÿæ˜Ÿåœ¨èƒŒé¢ï¼Œè¿™é‡Œä¸å¤„ç†ï¼Œç®€åŒ–ä¸ºç›´æ¥è¦†ç›–
                p.draw(); 
            });

            // 4. æœ€åç”»æ˜Ÿæ˜Ÿ (æ°¸è¿œæœ€äº®)
            star.draw();

            requestAnimationFrame(animate);
        }
        animate();
    </script>
</body>
</html>
